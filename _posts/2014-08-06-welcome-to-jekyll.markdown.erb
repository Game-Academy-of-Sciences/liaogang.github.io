---
layout: post
title:  "Welcome to Jekyll!"
date:   2014-08-06 
categories: jekyll update
---

You'll find this post in your `_posts` directory - edit this post and re-build (or run with the `-w` switch) to see your changes!
To add new posts, simply add a file in the `_posts` directory that follows the convention: YYYY-MM-DD-name-of-post.ext.

Jekyll also offers powerful support for code snippets:

{% highlight c++ %}
/**
 *
 */

#include <stdlib.h>
#include "lrcFch_qianqian.h"
#include "lrcFch_ting.h"
#include <pthread.h>
#include "threadpool.h"
#include "fileCtrl.h"
#include "audioTag.h"
#include <unistd.h>

#include <sys/stat.h>//stat


#ifdef DEBUG
#include <assert.h>
#endif


int runningJobs = 0;
int totalDownload = 0;
int downloadFailed = 0;
int downloadByQianQian=0;
int downloadByTing=0;
int tagFileFinded=0;
int skiped=0;

/**
 * brief "artist" , "title" , "/a/b"  to "/a/b/artist-title.lrc"
 * param lyricsFilename : path to save. without a '/'.
 */
char *GenerateLyricsName(const char *artist , const char *title ,const char *path , char *fullname)
{
    char *tmp ;

    tmp = strcpy ( fullname ,path );
    
    int len = strlen(path) -1 ;
    if(path[len] != '/')
        tmp = strcat(fullname , "/" );
    
    tmp =  strcat( tmp ,artist  );
    
    tmp =strcat(tmp, "-");
    
    tmp = strcat(tmp , title );
    
    strcat(tmp , ".lrc");
    
    return fullname;
}



struct lrcFchS
{
    char artist[128];
    char title[128] ;
    char *savepath;
};

void lrcFchSInit(lrcFchS *s, const char *a , const char *t, const char *p)
{
    if(a)
        strcpy(s->artist, a);
    if(t)
        strcpy(s->title, t);
    
    strcpy(s->savepath, p);
    
    //s->savepath=(char*)p;
}



void * lrcFchThread(void* lrcFchArg)
{
    bool bRet = false ;

    lrcFchS *s = (lrcFchS*)lrcFchArg ;
    const char *artist = s->artist;
    const char *title = s->title;
    const char *savepath= s->savepath;
    
    //printf("thread %u: beginning to search: %s , %s.\n",pthread_self() ,artist , title );
    
    //fetch from qianqian server first.
    SearchLyric sl;
    char fullname[128] ={ 0 };
    GenerateLyricsName(artist ,title , savepath ,fullname );
    
    if(  sl.Search(artist,title) )
    {
        bRet = sl.Download( fullname);
    }

    //then baidu ting server.
    if (bRet) 
    {
	downloadByQianQian++;
    }
    else
    {
        bRet = tingSearchDownload(artist, title, fullname);
	if(bRet)
	{
	    downloadByTing++;
	}
    }

    
    if(!bRet)
    {
       printf("\033[;31mwdownload failed\033[0m: %s, %s \n",artist ,title  );
    }
    
    
    runningJobs--;
    totalDownload++;

    if(bRet == false )
        downloadFailed++;

    free(s);

    return 0;
}

bool FileExists(const char* filename)
{
    struct stat info;
    int ret = -1;
    
    //get the file attributes
    ret = stat(filename, &info);
    if(ret == 0)
    {
        //stat() is able to get the file attributes,
        //so the file obviously exists
        return true;
    }
    else
    {
        //stat() is not able to get the file attributes,
        //so the file obviously does not exist or
        //more capabilities is required
        return false;
    }
}


char *_savepath = 0;
void* addJobIsFileAudio(const char * file ,void *arg)
{
    lrcFchS * lrcFchArg = (lrcFchS*)malloc(sizeof(lrcFchS)) ;
    
    lrcFchArg->savepath = _savepath;
    
    
    if (getId3Info(file , lrcFchArg->artist,  lrcFchArg->title )    )
    {
        //printf("%u , audio's tag info : %s , %s." , pthread_self() ,lrcFchArg->artist , lrcFchArg ->title );
        
        tagFileFinded++;
        
        char fullname[128] = {0 };
        
        GenerateLyricsName( lrcFchArg->artist , lrcFchArg->title , lrcFchArg->savepath , fullname );
        
        //if fullname is exist in file system. ignore to search and download the lyrics.
        if (  FileExists(fullname ) )
        {
            skiped++;
            printf("file exists,skip. %s\n",fullname);
        }
        else
        {
            //printf("\n");
            pool_add_job(lrcFchThread, (void*)lrcFchArg );
            runningJobs++;
        }
    }
    
    return nullptr;
}





void usage(const char *exec)
{
    int len = strlen (exec );
    
    char *ext =(char*)exec + len ;
    
    for (; ext[-1] != '/' ; ext -= 1 )
        ;
    
    
    printf("This is a program to download music track's lyrics from internet.\n");
    printf("usage: %s [music folder] [download folder] \n", ext );
}


int main(int argc, const char * argv[])
{
    if (argc != 3 )
    {
        usage( argv[0] );
        return 0;
    }
    
    const char * sourceFolder = argv[1];
    //const char * targetFolder = argv[2];
    _savepath =(char*)argv[2];
    
    pool_init(8);
    
    IterFiles(string (sourceFolder ), string (sourceFolder ), addJobIsFileAudio, nullptr );
    
    
    
    while (runningJobs > 0)
    {
        sleep(1);
    }
    
    
    pool_destroy();
 
    printf("\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nSummary:\n");
    printf(": audio source directory: \033[;32m%s\033[0m\n",argv[1]);
    printf(": target lyrics directory: \033[;32m%s\033[0m\n\n",argv[2]);
    printf("\033[;32m%-4d\033[0m Audio File with tag Finded.\n",tagFileFinded);
    if(skiped>0)
	printf("\033[;32m%-4d\033[0m Audio File is skipped.\n",skiped);
    if(downloadFailed>0)
	printf("\033[;32m%-4d\033[0m failed to download.\n",downloadFailed);
    printf("\033[;32m%-4d\033[0m files downloaded.\n",totalDownload-downloadFailed);
    if(downloadByQianQian)
	printf("\033[;32m%-4d\033[0m  by qianqian server.\n",downloadByQianQian);
    if(downloadByTing)
	printf("\033[;32m%-4d\033[0m  by ting server.\n",downloadByTing);
    return 0;
}




{% endhighlight %}

Check out the [Jekyll docs][jekyll] for more info on how to get the most out of Jekyll. File all bugs/feature requests at [Jekyll's GitHub repo][jekyll-gh].

[jekyll-gh](https://github.com/jekyll/jekyll)

[jekyll](http://jekyllrb.com)
